<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Map Pins 地図（Firestore連携 + 標高等高線 + 尾根線）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA-LCzW2hPlP7fNoNCvMnaVws_KIac1kcw",
      authDomain: "animaroute-b8c2e.firebaseapp.com",
      projectId: "animaroute-b8c2e",
      storageBucket: "animaroute-b8c2e.firebasestorage.app",
      messagingSenderId: "175353624443",
      appId: "1:175353624443:web:4b6ec67850d9f337d3afde"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fetchPins = async () => {
      const snapshot = await getDocs(collection(db, "pins"));
      const pins = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.lat && data.lng) {
          pins.push(data);
        }
      });
      return pins;
    };

    const generateGridPoints = (center, delta = 0.001, gridSize = 10) => {
      const points = [];
      const offset = Math.floor(gridSize / 2);
      for (let i = -offset; i <= offset; i++) {
        for (let j = -offset; j <= offset; j++) {
          points.push({
            lat: center.lat + i * delta,
            lng: center.lng + j * delta
          });
        }
      }
      return points;
    };

    const fetchElevations = async (points) => {
      const query = points.map(p => `${p.lat},${p.lng}`).join('|');
      const url = `https://api.open-elevation.com/api/v1/lookup?locations=${query}`;
      const response = await fetch(url);
      const data = await response.json();
      return data.results.map(p => ({
        lat: p.latitude,
        lng: p.longitude,
        elevation: p.elevation
      }));
    };

    const initMap = async () => {
      const pins = await fetchPins();
      if (pins.length === 0) {
        alert("ピンが見つかりません");
        return;
      }

      const center = pins[0];
      const gridPoints = generateGridPoints(center);
      const elevationPoints = await fetchElevations(gridPoints);

      // 等高線対象の標高帯（例：100m ±5m）
      const targetElevation = 100;
      const tolerance = 5;
      const contourPoints = elevationPoints.filter(p =>
        p.elevation >= targetElevation - tolerance &&
        p.elevation <= targetElevation + tolerance
      );

      // 尾根線（標高が高い点を抽出してつなぐ）
      const sortedPoints = [...elevationPoints].sort((a, b) => b.elevation - a.elevation);
      const ridgePoints = sortedPoints.slice(0, 20); // 上位20点を尾根とみなす

      const map = new maplibregl.Map({
        container: 'map',
        style: {
          version: 8,
          sources: {
            basemap: {
              type: "raster",
              tiles: [
                "https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=KauGGeewfPox6WtVIF37"
              ],
              tileSize: 256,
              attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a>'
            }
          },
          layers: [
            { id: "basemap", type: "raster", source: "basemap" }
          ]
        },
        center: [center.lng, center.lat],
        zoom: 15
      });

      map.on('load', () => {
        // ピン表示
        pins.forEach(pin => {
          new maplibregl.Marker()
            .setLngLat([pin.lng, pin.lat])
            .setPopup(new maplibregl.Popup().setText(pin.title || "ピン"))
            .addTo(map);
        });

        // 等高線（オレンジ）
        if (contourPoints.length >= 2) {
          map.addSource('contour-line', {
            type: 'geojson',
            data: {
              type: "FeatureCollection",
              features: [{
                type: "Feature",
                geometry: {
                  type: "LineString",
                  coordinates: contourPoints.map(p => [p.lng, p.lat])
                },
                properties: {}
              }]
            }
          });

          map.addLayer({
            id: 'contour-line-layer',
            type: 'line',
            source: 'contour-line',
            paint: {
              'line-color': '#ff6600',
              'line-width': 3,
              'line-opacity': 0.8
            },
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            }
          });
        }

        // 尾根線（青）
        if (ridgePoints.length >= 2) {
          map.addSource('ridge-line', {
            type: 'geojson',
            data: {
              type: "FeatureCollection",
              features: [{
                type: "Feature",
                geometry: {
                  type: "LineString",
                  coordinates: ridgePoints.map(p => [p.lng, p.lat])
                },
                properties: {}
              }]
            }
          });

          map.addLayer({
            id: 'ridge-line-layer',
            type: 'line',
            source: 'ridge-line',
            paint: {
              'line-color': '#0066cc',
              'line-width': 2,
              'line-opacity': 0.9
            },
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            }
          });
        }
      });
    };

    initMap();
  </script>
</body>
</html>